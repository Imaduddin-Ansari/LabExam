# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Node.js CI

on: 
 push: 
  branches: 
   - master

jobs: 
 build: 
  runs-on: ubuntu-latest 
  steps: 
  - name: Checkout code 
    uses: actions/checkout@v2 
  - name: Set up Node.js 
    uses: actions/setup-node@v2 
    with: 
     node-version: '14' 
  - name: Install dependencies 
    run: npm install
  - name: Log in to Docker Hub 
    uses: docker/login-action@v2 
    with: 
     username: ${{ secrets.DOCKERHUB_USERNAME }} 
     password: ${{ secrets.DOCKERHUB_TOKEN }} 
  - name: Build and push Docker image 
    run: | 
     docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/my-express-app:latest . 
     docker push ${{ secrets.DOCKERHUB_USERNAME }}/my-express-app:latest

 cleanDocker: 
  runs-on: ubuntu-latest 
  steps: 
  - name: Clean up old Docker containers 
    uses: appleboy/ssh-action@v0.1.1 
    with: 
     host: ${{ secrets.HOST_IP }} 
     username: ${{ secrets.SSH_USERNAME }} 
     key: ${{ secrets.HOST_SSH_PRIVATE_KEY }} 
     script: | 
      docker stop my-express-app || true 
      docker rm my-express-app || true
